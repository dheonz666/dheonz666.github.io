<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Opname Cloud Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library Barcode -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- Library Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Library Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .print-area { width: 100%; }
            .barcode-card { 
                border: 1px solid #e5e7eb; 
                break-inside: avoid;
                page-break-inside: avoid;
                margin-bottom: 1rem;
            }
        }

        .barcode-container svg {
            width: 100%;
            height: auto;
            max-height: 65px;
        }

        .loader {
            border-top-color: #4f46e5;
            animation: spinner 0.6s linear infinite;
        }

        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .login-bg {
            background: radial-gradient(circle at top right, #f8fafc 0%, #ffffff 100%);
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <!-- Login Section -->
    <div id="loginSection" class="fixed inset-0 z-[60] login-bg flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-[2.5rem] shadow-2xl shadow-indigo-100 p-8 border border-slate-100">
            <div class="text-center mb-8">
                <div class="bg-indigo-600 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-indigo-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </div>
                <h2 class="text-2xl font-extrabold text-slate-900">Scanner</h2>
                <p class="text-slate-500 text-sm mt-1">Masuk untuk memulai stock opname.</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Email</label>
                    <input type="email" id="loginEmail" required placeholder="user@company.com"
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Password</label>
                    <input type="password" id="loginPassword" required placeholder="••••••••"
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl transition-all shadow-lg shadow-indigo-200 active:scale-[0.98] mt-2">
                    Masuk
                </button>
            </form>
            <div id="loginErrorBox" class="hidden mt-4 p-4 bg-rose-50 border border-rose-100 rounded-2xl">
                <p id="loginError" class="text-rose-600 text-xs font-semibold text-center"></p>
                <p id="authTip" class="text-[10px] text-rose-400 text-center mt-1 italic border-t border-rose-100 pt-1">Tip: Pastikan 'Confirm Email' sudah OFF di Supabase.</p>
            </div>
        </div>
    </div>

    <!-- Main Content (Protected) -->
    <div id="mainContent" class="hidden">
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="fixed inset-0 bg-white/80 z-50 hidden flex flex-col items-center justify-center">
            <div class="loader w-12 h-12 border-4 border-slate-200 rounded-full mb-4"></div>
            <p class="text-indigo-600 font-semibold animate-pulse">Memuat Data...</p>
        </div>

        <div class="max-w-6xl mx-auto p-4 md:p-8">
            <!-- Header -->
            <header class="mb-10 flex flex-col md:flex-row justify-between items-center gap-4 no-print">
                <div class="text-center md:text-left">
                    <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">Stock Opname <span class="text-indigo-600">Cloud</span></h1>
                    <div class="mt-3 flex items-center justify-center md:justify-start gap-3">
                        <div id="statusDot" class="h-2.5 w-2.5 rounded-full bg-slate-300"></div>
                        <p id="statusText" class="text-sm font-medium text-slate-500 uppercase tracking-wider">Menghubungkan...</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span id="userDisplay" class="hidden md:inline-block text-xs font-bold text-slate-400 bg-slate-100 px-3 py-1 rounded-full"></span>
                    <a href="admin.html" class="inline-flex items-center gap-1.5 px-4 py-2 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 rounded-xl text-sm font-bold transition-all border border-indigo-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Panel Admin
                    </a>
                    <button onclick="handleLogout()" class="px-4 py-2 text-rose-500 hover:text-rose-700 font-bold text-sm bg-rose-50 border border-rose-100 rounded-xl transition-all">Keluar</button>
                </div>
            </header>

            <!-- Input Section -->
            <div class="bg-white p-8 rounded-3xl shadow-xl shadow-slate-200/50 mb-10 no-print border border-slate-100">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase ml-1">Lokasi Area</label>
                        <select id="areaInput" class="w-full bg-slate-50 border-0 rounded-2xl p-4 ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500 transition-all outline-none appearance-none">
                            <script>
                                for(let i=65; i<=90; i++) {
                                    const char = String.fromCharCode(i);
                                    document.write(`<option value="${char}">Area ${char}</option>`);
                                }
                            </script>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase ml-1">Kode Barcode</label>
                        <input type="text" id="barcodeInput" placeholder="Scan barcode di sini..." 
                            class="w-full bg-slate-50 border-0 rounded-2xl p-4 ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500 transition-all outline-none">
                    </div>

                    <div class="space-y-2">
                        <label class="text-xs font-bold text-slate-500 uppercase ml-1">Jumlah Item</label>
                        <input type="number" id="qtyInput" value="1" min="1" 
                            class="w-full bg-slate-50 border-0 rounded-2xl p-4 ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500 transition-all outline-none">
                    </div>

                    <button onclick="saveToCloud()" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-2xl transition-all shadow-lg shadow-indigo-200 active:scale-95">
                        Simpan Data
                    </button>
                </div>
            </div>

            <!-- Toolbar & Stats -->
            <div class="flex flex-wrap justify-between items-end mb-6 gap-4 no-print">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Daftar Inventaris</h2>
                    <p class="text-slate-500 text-sm">Data tersimpan secara otomatis di Cloud</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="exportExcel()" class="bg-emerald-50 hover:bg-emerald-100 text-emerald-700 px-5 py-2.5 rounded-xl font-bold text-sm transition-colors border border-emerald-100">Excel</button>
                    <button onclick="exportWord()" class="bg-blue-50 hover:bg-blue-100 text-blue-700 px-5 py-2.5 rounded-xl font-bold text-sm transition-colors border border-blue-100">Word</button>
                    <button onclick="window.print()" class="bg-slate-900 hover:bg-black text-white px-5 py-2.5 rounded-xl font-bold text-sm transition-all shadow-md">Cetak PDF</button>
                </div>
            </div>

            <!-- Data Display Area -->
            <div id="stockContainer" class="space-y-10 print-area pb-20">
                <!-- Render via JS -->
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI SUPABASE ---
        const SB_URL = 'https://wqgqyrqjtazqkdellkbo.supabase.co'; 
        const SB_KEY = 'sb_publishable_y2KBNtIQG1e7TWrJbiQFJg_jjykI3bC'; 
        
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        let inventoryData = {};

        // Inisialisasi Auth
        document.addEventListener('DOMContentLoaded', async () => {
            checkSession();
        });

        async function checkSession() {
            // Cek sesi awal secara langsung
            const { data: { session } } = await supabaseClient.auth.getSession();
            updateUIBasedOnAuth(session);

            // Pasang pendengar perubahan status login
            supabaseClient.auth.onAuthStateChanged((_event, session) => {
                updateUIBasedOnAuth(session);
            });
        }

        function updateUIBasedOnAuth(session) {
            const loginSection = document.getElementById('loginSection');
            const mainContent = document.getElementById('mainContent');
            const userDisplay = document.getElementById('userDisplay');

            // Ganti tampilan secara instan
            if (session) {
                loginSection.classList.add('hidden');
                mainContent.classList.remove('hidden');
                userDisplay.innerText = session.user.email;
                // Jalankan koneksi database di latar belakang
                initConnection();
            } else {
                loginSection.classList.remove('hidden');
                mainContent.classList.add('hidden');
                inventoryData = {}; // Kosongkan data lokal
            }
        }

        // --- AUTH ACTIONS ---
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorBox = document.getElementById('loginErrorBox');
            const errorEl = document.getElementById('loginError');
            
            errorBox.classList.add('hidden');
            toggleLoading(true, "Memproses Masuk...");

            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });

            if (error) {
                errorEl.innerText = error.message;
                errorBox.classList.remove('hidden');
                toggleLoading(false);
            }
            // Jika berhasil, onAuthStateChanged akan otomatis mengalihkan tampilan
        });

        async function handleLogout() {
            // Dibuat instan tanpa confirm untuk pengalaman "langsung"
            toggleLoading(true, "Memproses Keluar...");
            await supabaseClient.auth.signOut();
            toggleLoading(false);
        }

        // --- DATABASE ACTIONS ---
        async function initConnection() {
            try {
                updateStatus('bg-amber-500', 'Mengecek Koneksi...');
                const { error } = await supabaseClient.from('stock_opname').select('id').limit(1);
                if (error) throw error;
                
                updateStatus('bg-green-500', 'Database Terhubung');
                await loadData();
            } catch (err) {
                console.error(err);
                updateStatus('bg-red-500', 'Gagal Terhubung ke Cloud');
            }
        }

        function updateStatus(colorClass, text) {
            const dot = document.getElementById('statusDot');
            const txt = document.getElementById('statusText');
            if(dot && txt) {
                dot.className = `h-2.5 w-2.5 rounded-full ${colorClass}`;
                txt.innerText = text;
            }
        }

        function toggleLoading(show, message = "Memuat Data...") {
            const loader = document.getElementById('loadingOverlay');
            const loaderText = loader?.querySelector('p');
            if(loader) {
                if(loaderText) loaderText.innerText = message;
                loader.classList.toggle('hidden', !show);
            }
        }

        async function loadData() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if(!session) return;

            toggleLoading(true);
            const { data, error } = await supabaseClient
                .from('stock_opname')
                .select('*')
                .order('area', { ascending: true })
                .order('created_at', { ascending: false });

            if (!error && data) {
                inventoryData = {};
                data.forEach(item => {
                    if (!inventoryData[item.area]) inventoryData[item.area] = [];
                    inventoryData[item.area].push(item);
                });
                renderUI();
            }
            toggleLoading(false);
        }

        async function saveToCloud() {
            const area = document.getElementById('areaInput').value;
            const barcode = document.getElementById('barcodeInput').value.trim();
            const qty = parseInt(document.getElementById('qtyInput').value);

            if (!barcode) return alert('Silakan scan atau masukkan barcode!');

            toggleLoading(true, "Menyimpan...");
            const existing = (inventoryData[area] || []).find(i => i.barcode === barcode);

            if (existing) {
                const { error } = await supabaseClient
                    .from('stock_opname')
                    .update({ qty: existing.qty + qty })
                    .eq('id', existing.id);
                if (error) alert('Gagal update data');
            } else {
                const { error } = await supabaseClient
                    .from('stock_opname')
                    .insert([{ area, barcode, qty }]);
                if (error) alert('Gagal menyimpan data baru');
            }

            document.getElementById('barcodeInput').value = '';
            document.getElementById('qtyInput').value = '1';
            document.getElementById('barcodeInput').focus();
            
            await loadData();
        }

        async function deleteItem(id) {
            if (!confirm('Hapus item ini secara permanen dari Cloud?')) return;
            toggleLoading(true, "Menghapus...");
            const { error } = await supabaseClient.from('stock_opname').delete().eq('id', id);
            if (error) alert('Gagal menghapus data');
            await loadData();
        }

        function renderUI() {
            const container = document.getElementById('stockContainer');
            const areas = Object.keys(inventoryData).sort();

            if (areas.length === 0) {
                container.innerHTML = `<div class="text-center py-24 bg-white rounded-3xl border-2 border-dashed border-slate-200 no-print"><p class="text-slate-500 font-medium">Belum ada data di cloud. Silakan input stok baru.</p></div>`;
                return;
            }

            container.innerHTML = "";
            areas.forEach(area => {
                const section = document.createElement('div');
                section.className = "bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden mb-8";
                
                let html = `
                    <div class="bg-slate-50 border-b border-slate-100 px-8 py-5 flex justify-between items-center">
                        <h3 class="text-xl font-extrabold text-slate-900 tracking-tight underline decoration-indigo-500 decoration-4 underline-offset-8">AREA ${area}</h3>
                        <div class="bg-white px-4 py-1.5 rounded-full border border-slate-200 text-xs font-bold text-slate-500 uppercase tracking-widest">
                            ${inventoryData[area].length} Tipe Barcode
                        </div>
                    </div>
                    <div class="p-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                `;

                inventoryData[area].forEach(item => {
                    html += `
                        <div class="barcode-card group relative bg-white border border-slate-200 rounded-2xl p-5 hover:border-indigo-300 transition-all">
                            <button onclick="deleteItem('${item.id}')" class="no-print absolute top-3 right-3 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <div class="barcode-container mb-4">
                                <svg id="bc-${item.id}"></svg>
                            </div>
                            <div class="text-center pt-3 border-t border-slate-50">
                                <span class="block text-[10px] font-black text-slate-400 uppercase tracking-tighter mb-1">${item.barcode}</span>
                                <div class="text-2xl font-black text-slate-800">QTY: ${item.qty}</div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
                section.innerHTML = html;
                container.appendChild(section);

                inventoryData[area].forEach(item => {
                    JsBarcode(`#bc-${item.id}`, item.barcode, {
                        format: "CODE128", width: 1.8, height: 45, displayValue: false, margin: 0
                    });
                });
            });
        }

        // --- EXPORTS ---
        function exportExcel() {
            if (Object.keys(inventoryData).length === 0) return alert('Tidak ada data');
            const flatData = [];
            Object.keys(inventoryData).forEach(area => {
                inventoryData[area].forEach(item => {
                    flatData.push({ "Area": area, "Barcode": item.barcode, "Jumlah": item.qty, "Waktu Input": new Date(item.created_at).toLocaleString() });
                });
            });
            const ws = XLSX.utils.json_to_sheet(flatData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "StockOpname");
            XLSX.writeFile(wb, `Stock_Opname_Cloud_${new Date().getTime()}.xlsx`);
        }

        function exportWord() {
            if (Object.keys(inventoryData).length === 0) return alert('Tidak ada data');
            let docHeader = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head><meta charset='utf-8'><style>table { border-collapse: collapse; width: 100%; } th, td { border: 1px solid black; padding: 10px; } h2 { color: #4f46e5; }</style></head><body><h1>LAPORAN STOCK OPNAME</h1>`;
            let body = "";
            Object.keys(inventoryData).sort().forEach(area => {
                body += `<h2>AREA ${area}</h2><table><thead><tr><th>Barcode</th><th>Jumlah</th></tr></thead><tbody>`;
                inventoryData[area].forEach(item => { body += `<tr><td>${item.barcode}</td><td>${item.qty}</td></tr>`; });
                body += `</tbody></table><br>`;
            });
            const blob = new Blob(['\ufeff', docHeader + body + "</body></html>"], { type: 'application/msword' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "Laporan_Stock.doc";
            link.click();
        }
    </script>
</body>
</html>