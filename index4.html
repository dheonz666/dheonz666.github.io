<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <link href="assets/img/scanner.png" rel="icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Opname - Sparepart (Local Storage)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Library SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .barcode-container svg { width: 100%; height: auto; max-height: 65px; }
        .loader { border-top-color: #4f46e5; animation: spinner 0.6s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .excel-table { border-collapse: separate; border-spacing: 0; width: 100%; }
        .excel-table th { position: sticky; top: 0; background: #f8fafc; z-index: 10; cursor: pointer; user-select: none; transition: background-color 0.2s; }
        .excel-table th:hover { background-color: #f1f5f9; }
        @keyframes highlight-new { 0% { background-color: #eef2ff; } 100% { background-color: transparent; } }
        .new-entry { animation: highlight-new 2s ease-out; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <div id="loadingOverlay" class="fixed inset-0 bg-white/80 z-50 hidden flex flex-col items-center justify-center">
        <div class="loader w-12 h-12 border-4 border-slate-200 rounded-full mb-4"></div>
        <p class="text-indigo-600 font-semibold animate-pulse">Memproses Data...</p>
    </div>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <header class="mb-10 text-center">
            <div class="flex items-center justify-center gap-3 mb-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                </svg>
                <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight">
                    <span class="text-indigo-600">Stock Opname Sparepart</span>
                </h1>
            </div>
            <div class="flex items-center justify-center gap-3">
                <div id="statusDot" class="h-2.5 w-2.5 rounded-full bg-blue-500"></div>
                <p id="statusText" class="text-sm font-medium text-slate-500 uppercase tracking-wider">Mode Penyimpanan Lokal (Offline)</p>
            </div>
        </header>

        <!-- Input Section -->
        <div class="bg-white p-8 rounded-3xl shadow-xl shadow-slate-200/50 mb-10 border border-slate-100">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1">Area Sparepart</label>
                    <div class="relative">
                        <select id="areaInput" class="w-full bg-slate-50 border-0 rounded-2xl p-4 ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500 transition-all outline-none appearance-none">
                            <script>
                                const spLetters = ['A', 'B', 'C', 'D', 'E', 'F'];
                                spLetters.forEach(letter => {
                                    document.write(`<optgroup label="SPAREPART AREA ${letter}">`);
                                    for(let i=1; i<=40; i++) {
                                        const areaNum = i < 10 ? '0' + i : i;
                                        document.write(`<option value="${letter}${areaNum}">${letter}${areaNum}</option>`);
                                    }
                                    document.write(`</optgroup>`);
                                });
                            </script>
                        </select>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1">Kode Barcode</label>
                    <input type="text" id="barcodeInput" placeholder="Scan barcode..." 
                        class="w-full bg-slate-50 border-0 rounded-2xl p-4 ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500 transition-all outline-none"
                        onkeypress="if(event.key === 'Enter') saveToLocal()">
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1">Jumlah Item</label>
                    <input type="number" id="qtyInput" value="1" min="1" 
                        class="w-full bg-slate-50 border-0 rounded-2xl p-4 ring-1 ring-slate-200 focus:ring-2 focus:ring-indigo-500 transition-all outline-none">
                </div>

                <button onclick="saveToLocal()" 
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-2xl transition-all shadow-lg shadow-indigo-200 active:scale-95">
                    Simpan Data
                </button>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="flex flex-col space-y-6 mb-10">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Daftar Inventaris</h2>
                    <p class="text-slate-500 text-sm">Data tersimpan di Browser (Aman selama cache tidak dihapus)</p>
                </div>
                <button onclick="clearAllData()" class="text-xs font-bold text-red-500 hover:text-red-700 transition-colors uppercase tracking-widest bg-red-50 px-4 py-2 rounded-xl">
                    Hapus Semua Data
                </button>
            </div>

            <div class="flex flex-col xl:flex-row justify-between items-center gap-6 bg-slate-100/50 p-4 rounded-2xl border border-slate-200/50">
                <div class="flex flex-wrap items-end gap-4 w-full xl:w-auto">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Tampilan</label>
                        <select id="modeSelector" onchange="switchView(this.value)" class="bg-white border border-slate-200 rounded-xl px-3 py-2 text-xs font-bold text-slate-700 h-[38px] shadow-sm">
                            <option value="grid">Mode Kartu</option>
                            <option value="table" selected>Mode Tabel</option>
                        </select>
                    </div>

                    <div class="space-y-1 w-full md:w-44 lg:w-56">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Cari Barcode / Area</label>
                        <input type="text" id="searchInput" oninput="renderUI()" placeholder="Cari..." class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm h-[38px] shadow-sm">
                    </div>

                    <div class="space-y-1 w-full md:w-36">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Filter Area</label>
                        <select id="viewFilter" onchange="renderUI()" class="w-full bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm h-[38px] shadow-sm">
                            <option value="all">Semua Area</option>
                        </select>
                    </div>

                    <div class="pb-0.5">
                        <button onclick="resetFilters()" class="bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 px-4 py-2 rounded-xl font-bold text-xs h-[38px]">Reset</button>
                    </div>
                </div>

                <div class="flex flex-wrap gap-2 w-full xl:w-auto justify-end items-end">
                    <button onclick="exportExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl font-bold text-xs h-[38px]">Ekspor Excel</button>
                </div>
            </div>
        </div>

        <div id="stockContainer" class="space-y-10 pb-20"></div>
    </div>

    <script>
        // --- UTILITY COOKIE ---
        const CookieHelper = {
            set: (name, value, days = 7) => {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/`;
            },
            get: (name) => {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                return null;
            }
        };

        // Konfigurasi SweetAlert2 Default
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
        });

        let inventoryData = [];
        let currentView = CookieHelper.get('view_mode') || 'table';
        let sortConfig = { key: 'created_at', direction: 'desc' }; 
        let lastScannedId = null;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('modeSelector').value = currentView;
            loadFromLocalStorage();
            document.getElementById('barcodeInput').focus();
        });

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('sparepart_inventory');
            inventoryData = saved ? JSON.parse(saved) : [];
            updateFilterDropdown();
            renderUI();
        }

        function saveToLocalStorage() {
            localStorage.setItem('sparepart_inventory', JSON.stringify(inventoryData));
        }

        function updateFilterDropdown() {
            const filterSelect = document.getElementById('viewFilter');
            const areas = [...new Set(inventoryData.map(i => i.area))].sort();
            let html = '<option value="all">Semua Area</option>';
            areas.forEach(area => {
                html += `<option value="${area}">${area.toUpperCase()}</option>`;
            });
            filterSelect.innerHTML = html;
        }

        function toggleLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
        }

        function switchView(view) {
            currentView = view;
            CookieHelper.set('view_mode', view);
            renderUI();
        }

        function resetFilters() {
            document.getElementById('viewFilter').value = 'all';
            document.getElementById('searchInput').value = '';
            renderUI();
        }

        async function clearAllData() {
            const result = await Swal.fire({
                title: 'Hapus Semua Data?',
                text: "Tindakan ini tidak bisa dibatalkan!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#4f46e5',
                cancelButtonColor: '#ef4444',
                confirmButtonText: 'Ya, Hapus Semua!',
                cancelButtonText: 'Batal'
            });

            if (result.isConfirmed) {
                inventoryData = [];
                saveToLocalStorage();
                renderUI();
                updateFilterDropdown();
                Swal.fire('Terhapus!', 'Semua data telah dibersihkan.', 'success');
            }
        }

        function saveToLocal() {
            const area = document.getElementById('areaInput').value;
            const barcode = document.getElementById('barcodeInput').value.trim();
            const qtyInputVal = document.getElementById('qtyInput').value;
            const qty = parseInt(qtyInputVal) || 1;

            if (!barcode) return;

            toggleLoading(true);

            setTimeout(() => {
                const existingIndex = inventoryData.findIndex(i => i.area === area && i.barcode === barcode);
                
                if (existingIndex !== -1) {
                    inventoryData[existingIndex].qty += qty;
                    inventoryData[existingIndex].created_at = new Date().toISOString();
                    lastScannedId = inventoryData[existingIndex].id;
                } else {
                    const newItem = {
                        id: Date.now(),
                        area: area,
                        barcode: barcode,
                        qty: qty,
                        created_at: new Date().toISOString()
                    };
                    inventoryData.push(newItem);
                    lastScannedId = newItem.id;
                }

                saveToLocalStorage();
                updateFilterDropdown();
                renderUI();
                
                Toast.fire({
                    icon: 'success',
                    title: 'Data berhasil disimpan'
                });

                document.getElementById('barcodeInput').value = '';
                document.getElementById('barcodeInput').focus();
                toggleLoading(false);
            }, 300);
        }

        async function deleteItem(id) {
            const result = await Swal.fire({
                title: 'Hapus Data?',
                text: "Baris ini akan dihapus dari daftar.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#6366f1',
                cancelButtonColor: '#94a3b8',
                confirmButtonText: 'Ya, Hapus',
                cancelButtonText: 'Batal'
            });

            if (result.isConfirmed) {
                inventoryData = inventoryData.filter(item => item.id !== id);
                saveToLocalStorage();
                updateFilterDropdown();
                renderUI();
                Toast.fire({
                    icon: 'success',
                    title: 'Data dihapus'
                });
            }
        }

        async function editItem(id) {
            const item = inventoryData.find(i => i.id === id);
            if (!item) return;

            const { value: newQty } = await Swal.fire({
                title: 'Edit Jumlah',
                text: `Update QTY untuk Barcode: ${item.barcode}`,
                input: 'number',
                inputLabel: 'Jumlah Item',
                inputValue: item.qty,
                showCancelButton: true,
                confirmButtonColor: '#4f46e5',
                inputValidator: (value) => {
                    if (!value || value < 0) {
                        return 'Masukkan jumlah yang valid (minimal 0)!';
                    }
                }
            });
            
            if (newQty !== undefined) {
                const parsedQty = parseInt(newQty);
                item.qty = parsedQty;
                item.created_at = new Date().toISOString();
                lastScannedId = id;
                saveToLocalStorage();
                renderUI();
                Toast.fire({
                    icon: 'success',
                    title: 'Jumlah diperbarui'
                });
            }
        }

        function getFilteredAndSortedData() {
            const filterArea = document.getElementById('viewFilter').value;
            const searchKeyword = document.getElementById('searchInput').value.toLowerCase().trim();
            
            let filtered = inventoryData.filter(item => {
                const passArea = (filterArea === 'all' || item.area === filterArea);
                const passSearch = !searchKeyword || 
                                   item.barcode.toLowerCase().includes(searchKeyword) || 
                                   item.area.toLowerCase().includes(searchKeyword);
                return passArea && passSearch;
            });

            filtered.sort((a, b) => {
                let valA = a[sortConfig.key], valB = b[sortConfig.key];
                if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });

            return filtered;
        }

        function renderUI() {
            const container = document.getElementById('stockContainer');
            const dataToRender = getFilteredAndSortedData();
            
            if (dataToRender.length === 0) {
                container.innerHTML = `<div class="text-center py-24 bg-white rounded-3xl border-2 border-dashed border-slate-200"><p class="text-slate-400">Belum ada data di simpan.</p></div>`;
                return;
            }

            container.innerHTML = "";
            if (currentView === 'grid') renderGridView(container, dataToRender);
            else renderTableView(container, dataToRender);
        }

        function renderGridView(container, flatData) {
            const grouped = {};
            flatData.forEach(item => {
                if(!grouped[item.area]) grouped[item.area] = [];
                grouped[item.area].push(item);
            });

            Object.keys(grouped).forEach(area => {
                const section = document.createElement('div');
                section.className = "bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden mb-8";
                let html = `<div class="bg-slate-50 border-b border-slate-100 px-8 py-5 flex justify-between items-center"><h3 class="text-xl font-bold text-slate-800">${area.toUpperCase()}</h3></div><div class="p-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">`;
                grouped[area].forEach(item => {
                    const isNew = item.id === lastScannedId ? 'ring-2 ring-indigo-500' : '';
                    html += `<div class="border border-slate-200 rounded-2xl p-5 ${isNew}"><div class="barcode-container mb-4"><svg id="bc-${item.id}"></svg></div><div class="text-center"><b class="text-slate-700">${item.barcode}</b><br><span class="text-indigo-600 font-bold">QTY: ${item.qty}</span></div></div>`;
                });
                html += `</div>`;
                section.innerHTML = html;
                container.appendChild(section);
                grouped[area].forEach(item => JsBarcode(`#bc-${item.id}`, item.barcode, { format: "CODE128", height: 40, displayValue: false }));
            });
        }

        function renderTableView(container, flatData) {
            const wrapper = document.createElement('div');
            wrapper.className = "bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden";
            let html = `
                <div class="overflow-x-auto">
                    <table class="excel-table min-w-full text-left">
                        <thead>
                            <tr class="bg-slate-50 border-b">
                                <th class="px-6 py-4 text-slate-600 font-bold uppercase text-[11px] tracking-wider">Area</th>
                                <th class="px-6 py-4 w-60 text-center text-slate-600 font-bold uppercase text-[11px] tracking-wider">Barcode (Visual)</th>
                                <th class="px-6 py-4 text-slate-600 font-bold uppercase text-[11px] tracking-wider">Kode</th>
                                <th class="px-6 py-4 text-slate-600 font-bold uppercase text-[11px] tracking-wider">QTY</th>
                                <th class="px-6 py-4 text-slate-600 font-bold uppercase text-[11px] tracking-wider">Waktu</th>
                                <th class="px-6 py-4 text-center text-slate-600 font-bold uppercase text-[11px] tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">`;
            
            flatData.forEach(item => {
                const isNew = item.id === lastScannedId ? 'new-entry' : '';
                html += `
                    <tr class="${isNew} hover:bg-slate-50/80 transition-colors">
                        <td class="px-6 py-4 font-bold text-slate-700">${item.area.toUpperCase()}</td>
                        <td class="px-6 py-4">
                            <div class="flex justify-center">
                                <svg id="bt-${item.id}" class="max-w-[200px]"></svg>
                            </div>
                        </td>
                        <td class="px-6 py-4 font-mono text-slate-600">${item.barcode}</td>
                        <td class="px-6 py-4 font-bold text-lg text-indigo-600">${item.qty}</td>
                        <td class="px-6 py-4 text-xs text-slate-400">${new Date(item.created_at).toLocaleString('id-ID', {hour:'2-digit', minute:'2-digit', day:'2-digit', month:'short'})}</td>
                        <td class="px-6 py-4">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="editItem(${item.id})" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors" title="Edit Jumlah">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button onclick="deleteItem(${item.id})" class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors" title="Hapus Baris">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>`;
            });
            html += `</tbody></table></div>`;
            wrapper.innerHTML = html;
            container.appendChild(wrapper);
            flatData.forEach(item => JsBarcode(`#bt-${item.id}`, item.barcode, { format: "CODE128", width: 2, height: 35, displayValue: false }));
        }

        function exportExcel() {
            if (inventoryData.length === 0) {
                Swal.fire('Oops!', 'Tidak ada data untuk diekspor.', 'info');
                return;
            }
            const data = inventoryData.map(i => ({ Area: i.area.toUpperCase(), Barcode: i.barcode, Qty: i.qty, Waktu: i.created_at }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventory");
            XLSX.writeFile(wb, `Stock_Sparepart_Local.xlsx`);
        }
    </script>
</body>
</html>
